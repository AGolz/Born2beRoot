text

%pre
iotty="$(tty)"
exec > "${iotty}" 2> "${iotty}"

while true; do
  read -s -p "Enter LUKS encryption key: " encryption_key
  echo    # Move to the next line after key entry
  
  echo "Entered passphrase: $encryption_key"

  echo -n "$encryption_key" | cryptsetup open --type luks --passphrase-fd 0 /dev/sda5 sda5_crypt && break

  cryptsetup_status=$?
  echo "cryptsetup status: $cryptsetup_status"

  if [ $cryptsetup_status -ne 0 ]; then
    echo "Incorrect key. Try again."
  else
    echo "LUKS device opened successfully."
  fi
done
%end
